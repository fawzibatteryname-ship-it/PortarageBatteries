<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battery Finder</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow-x: hidden;
        }

        .animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .battery-fall {
            position: absolute;
            width: 40px;
            height: 60px;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
                opacity: 0;
            }
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '▼';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.75rem;
            color: #FFD700;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #FFD700;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 1rem;
            padding: 2rem;
            color: #000;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .result-box:hover {
            transform: translateY(-5px);
        }

        .error-message {
            background-color: #400;
            border: 1px solid #800;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            color: #FFD700;
        }

        .main-content {
            position: relative;
            z-index: 10;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #2a2a2a;
            border: 2px solid #FFD700;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            color: #FFD700;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #444;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #3a3a3a;
        }

        .suggestions-list::-webkit-scrollbar {
            width: 8px;
        }

        .suggestions-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .suggestions-list::-webkit-scrollbar-thumb {
            background: #FFD700;
            border-radius: 4px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="min-h-full w-full">
  <div class="animation-container" id="animation-container"></div>
  <div class="w-full min-h-full p-8 main-content" style="background-color: #000000;">
   <div class="max-w-2xl mx-auto">
    <div class="rounded-2xl shadow-2xl p-8" style="background-color: #1a1a1a; border: 2px solid #FFD700;">
     <div class="flex justify-center mb-8"><img id="main-logo" src="https://i.top4top.io/p_35860o72q1.png" alt="Portarage Logo" style="width: 200px; height: auto;" onerror="this.style.display='none';">
     </div>
     <p id="subtitle" class="text-center mb-8" style="display: none;"></p>
     <div id="loading-initial" class="text-center py-8">
      <div class="loading mx-auto mb-4"></div>
      <p style="color: #FFD700;">جاري تحميل البيانات...</p>
     </div>
     <div id="error-container"></div>
     <div id="form-container" style="display: none;">
      <div class="mb-6"><label id="make-label" class="block font-semibold mb-2" style="color: #FFD700;">الشركة المصنعة</label>
       <div style="position: relative;"><input type="text" id="make-input" placeholder="ابحث عن الشركة المصنعة..." class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition-colors" style="background-color: #2a2a2a; color: #FFD700; border-color: #FFD700;" autocomplete="off">
        <div id="make-suggestions" class="suggestions-list" style="display: none;"></div>
       </div>
      </div>
      <div id="model-container" class="mb-6" style="display: none;"><label id="model-label" class="block font-semibold mb-2" style="color: #FFD700;">الموديل</label>
       <div style="position: relative;"><input type="text" id="model-input" placeholder="ابحث عن الموديل..." class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition-colors" style="background-color: #2a2a2a; color: #FFD700; border-color: #FFD700;" autocomplete="off">
        <div id="model-suggestions" class="suggestions-list" style="display: none;"></div>
       </div>
      </div>
      <div id="year-container" class="mb-6" style="display: none;"><label id="year-label" class="block font-semibold mb-2" style="color: #FFD700;">السنة</label>
       <div style="position: relative;"><input type="text" id="year-input" placeholder="ابحث عن السنة..." class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition-colors" style="background-color: #2a2a2a; color: #FFD700; border-color: #FFD700;" autocomplete="off">
        <div id="year-suggestions" class="suggestions-list" style="display: none;"></div>
       </div>
      </div>
      <div id="result-container" style="display: none;">
       <h3 id="result-label" class="text-xl font-bold mb-4" style="color: #FFD700;">معلومات البطا��ية:</h3>
       <div id="battery-results-list"></div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        const SHEET_ID = '1tUjEj-1FtAqewhJiRcC4dgGwgrxhb5OjKxGWEojFzlg';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        
        let allData = [];
        
        const defaultConfig = {
            main_title: 'Portarage Batteries',
            subtitle: '',
            make_label: 'الشركة المصنعة',
            model_label: 'الموديل',
            year_label: 'السنة',
            result_label: 'معلومات البطارية:',
            background_color: '#000000',
            surface_color: '#1a1a1a',
            text_color: '#FFD700',
            primary_color: '#FFD700',
            secondary_color: '#FFA500'
        };

        async function onConfigChange(config) {
            const subtitleEl = document.getElementById('subtitle');
            if (config.subtitle || defaultConfig.subtitle) {
                subtitleEl.textContent = config.subtitle || defaultConfig.subtitle;
                subtitleEl.style.display = 'block';
            } else {
                subtitleEl.style.display = 'none';
            }
            document.getElementById('make-label').textContent = config.make_label || defaultConfig.make_label;
            document.getElementById('model-label').textContent = config.model_label || defaultConfig.model_label;
            document.getElementById('year-label').textContent = config.year_label || defaultConfig.year_label;
            document.getElementById('result-label').textContent = config.result_label || defaultConfig.result_label;

            const bgColor = config.background_color || defaultConfig.background_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;

            document.querySelector('.bg-gradient-to-br').style.background = bgColor;
            document.querySelector('.bg-white').style.backgroundColor = surfaceColor;
            
            document.querySelectorAll('.text-gray-700, .text-gray-800, .text-gray-600').forEach(el => {
                el.style.color = textColor;
            });

            const selectElements = document.querySelectorAll('select');
            selectElements.forEach(select => {
                select.style.borderColor = primaryColor;
                select.style.backgroundColor = surfaceColor;
                select.style.color = textColor;
            });

            const resultBox = document.querySelector('.result-box');
            if (resultBox) {
                resultBox.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
            }
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.surface_color || defaultConfig.surface_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ surface_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.secondary_color || defaultConfig.secondary_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ['main_title', config.main_title || defaultConfig.main_title],
                ['subtitle', config.subtitle || defaultConfig.subtitle],
                ['make_label', config.make_label || defaultConfig.make_label],
                ['model_label', config.model_label || defaultConfig.model_label],
                ['year_label', config.year_label || defaultConfig.year_label],
                ['result_label', config.result_label || defaultConfig.result_label]
            ]);
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                const text = await response.text();
                
                // Parse Google Sheets JSON response
                const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/)?.[1] || text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonString);
                
                if (!json.table || !json.table.rows) {
                    throw new Error('Invalid data format');
                }
                
                const rows = json.table.rows;
                allData = rows.slice(1).map(row => {
                    if (!row.c) return null;
                    return {
                        make: row.c[0]?.v?.toString() || '',
                        model: row.c[1]?.v?.toString() || '',
                        year: row.c[2]?.v?.toString() || '',
                        bat: row.c[3]?.v?.toString() || '',
                        countOfID: row.c[4]?.v?.toString() || ''
                    };
                }).filter(item => item && item.make && item.model && item.year);

                if (allData.length === 0) {
                    throw new Error('No data found in sheet');
                }

                document.getElementById('loading-initial').style.display = 'none';
                document.getElementById('form-container').style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading-initial').style.display = 'none';
                showError('عذراً، حدث خطأ في تحميل البيانات. يرجى التحقق من رابط Google Sheet والتأكد من أن الملف متاح للجميع.');
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        let selectedMake = '';
        let selectedModel = '';
        let selectedYear = '';

        function showSuggestions(inputElement, suggestionsElement, items, onSelect) {
            const inputValue = inputElement.value.trim().toLowerCase();
            
            if (!inputValue) {
                suggestionsElement.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item;
                    div.onclick = () => {
                        inputElement.value = item;
                        suggestionsElement.style.display = 'none';
                        onSelect(item);
                    };
                    suggestionsElement.appendChild(div);
                });
                suggestionsElement.style.display = 'block';
                return;
            }

            const filteredItems = items.filter(item => 
                item.toLowerCase().includes(inputValue)
            );

            if (filteredItems.length === 0) {
                suggestionsElement.innerHTML = '<div class="suggestion-item" style="color: #999; cursor: default;">لا توجد نتائج</div>';
                suggestionsElement.style.display = 'block';
                return;
            }

            suggestionsElement.innerHTML = '';
            filteredItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                const itemLower = item.toLowerCase();
                const searchLower = inputValue;
                const index = itemLower.indexOf(searchLower);
                
                if (index !== -1) {
                    const before = item.substring(0, index);
                    const match = item.substring(index, index + inputValue.length);
                    const after = item.substring(index + inputValue.length);
                    div.innerHTML = `${before}<strong style="background-color: #FFA500; color: #000; padding: 0 2px; border-radius: 2px;">${match}</strong>${after}`;
                } else {
                    div.textContent = item;
                }
                
                div.onclick = () => {
                    inputElement.value = item;
                    suggestionsElement.style.display = 'none';
                    onSelect(item);
                };
                suggestionsElement.appendChild(div);
            });

            suggestionsElement.style.display = 'block';
        }

        function setupMakeInput() {
            const makeInput = document.getElementById('make-input');
            const makeSuggestions = document.getElementById('make-suggestions');
            const makes = [...new Set(allData.map(item => item.make))].sort();

            makeInput.addEventListener('focus', () => {
                showSuggestions(makeInput, makeSuggestions, makes, (make) => {
                    selectedMake = make;
                    setupModelInput(make);
                    document.getElementById('model-container').style.display = 'block';
                    document.getElementById('year-container').style.display = 'none';
                    document.getElementById('result-container').style.display = 'none';
                    document.getElementById('model-input').value = '';
                    document.getElementById('year-input').value = '';
                });
            });

            makeInput.addEventListener('input', () => {
                showSuggestions(makeInput, makeSuggestions, makes, (make) => {
                    selectedMake = make;
                    setupModelInput(make);
                    document.getElementById('model-container').style.display = 'block';
                    document.getElementById('year-container').style.display = 'none';
                    document.getElementById('result-container').style.display = 'none';
                    document.getElementById('model-input').value = '';
                    document.getElementById('year-input').value = '';
                });
            });

            makeInput.addEventListener('blur', () => {
                setTimeout(() => {
                    makeSuggestions.style.display = 'none';
                }, 200);
            });
        }

        function setupModelInput(make) {
            const modelInput = document.getElementById('model-input');
            const modelSuggestions = document.getElementById('model-suggestions');
            const models = [...new Set(
                allData
                    .filter(item => item.make === make)
                    .map(item => item.model)
            )].sort();

            modelInput.removeEventListener('focus', modelInput._focusHandler);
            modelInput.removeEventListener('input', modelInput._inputHandler);
            modelInput.removeEventListener('blur', modelInput._blurHandler);

            modelInput._focusHandler = () => {
                showSuggestions(modelInput, modelSuggestions, models, (model) => {
                    selectedModel = model;
                    setupYearInput(make, model);
                    document.getElementById('year-container').style.display = 'block';
                    document.getElementById('result-container').style.display = 'none';
                    document.getElementById('year-input').value = '';
                });
            };

            modelInput._inputHandler = () => {
                showSuggestions(modelInput, modelSuggestions, models, (model) => {
                    selectedModel = model;
                    setupYearInput(make, model);
                    document.getElementById('year-container').style.display = 'block';
                    document.getElementById('result-container').style.display = 'none';
                    document.getElementById('year-input').value = '';
                });
            };

            modelInput._blurHandler = () => {
                setTimeout(() => {
                    modelSuggestions.style.display = 'none';
                }, 200);
            };

            modelInput.addEventListener('focus', modelInput._focusHandler);
            modelInput.addEventListener('input', modelInput._inputHandler);
            modelInput.addEventListener('blur', modelInput._blurHandler);
        }

        function setupYearInput(make, model) {
            const yearInput = document.getElementById('year-input');
            const yearSuggestions = document.getElementById('year-suggestions');
            const years = [...new Set(
                allData
                    .filter(item => item.make === make && item.model === model)
                    .map(item => item.year.toString())
            )].sort((a, b) => b - a);

            yearInput.removeEventListener('focus', yearInput._focusHandler);
            yearInput.removeEventListener('input', yearInput._inputHandler);
            yearInput.removeEventListener('blur', yearInput._blurHandler);

            yearInput._focusHandler = () => {
                showSuggestions(yearInput, yearSuggestions, years, (year) => {
                    selectedYear = year;
                    showBatteryInfo(make, model, year);
                });
            };

            yearInput._inputHandler = () => {
                showSuggestions(yearInput, yearSuggestions, years, (year) => {
                    selectedYear = year;
                    showBatteryInfo(make, model, year);
                });
            };

            yearInput._blurHandler = () => {
                setTimeout(() => {
                    yearSuggestions.style.display = 'none';
                }, 200);
            };

            yearInput.addEventListener('focus', yearInput._focusHandler);
            yearInput.addEventListener('input', yearInput._inputHandler);
            yearInput.addEventListener('blur', yearInput._blurHandler);
        }

        function showBatteryInfo(selectedMake, selectedModel, selectedYear) {
            const batteryDataList = allData.filter(item => 
                item.make === selectedMake && 
                item.model === selectedModel && 
                item.year == selectedYear
            );

            if (batteryDataList.length > 0) {
                const resultsContainer = document.getElementById('battery-results-list');
                resultsContainer.innerHTML = '';

                const batteryInfoLines = batteryDataList.map(batteryData => 
                    `${batteryData.bat}, (${batteryData.countOfID})`
                ).join('<br>');

                const resultBox = document.createElement('div');
                resultBox.className = 'result-box';
                resultBox.innerHTML = `
                    <div class="text-center">
                        <p class="text-lg mb-2 opacity-90">حجم البطارية</p>
                        <p class="text-3xl font-bold">${batteryInfoLines}</p>
                    </div>
                `;
                resultsContainer.appendChild(resultBox);

                document.getElementById('result-container').style.display = 'block';
            }
        }

        async function fetchSheetDataAndSetup() {
            await fetchSheetData();
            setupMakeInput();
        }

        fetchSheetDataAndSetup();

        function createFallingBatteries() {
            const container = document.getElementById('animation-container');
            const numberOfBatteries = 15;

            for (let i = 0; i < numberOfBatteries; i++) {
                setTimeout(() => {
                    const battery = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    battery.classList.add('battery-fall');
                    battery.setAttribute('viewBox', '0 0 100 150');
                    battery.style.left = `${Math.random() * 100}%`;
                    battery.style.animationDuration = `${5 + Math.random() * 5}s`;
                    battery.style.animationDelay = `${Math.random() * 2}s`;

                    battery.innerHTML = `
                        <rect x="20" y="20" width="60" height="110" rx="5" fill="none" stroke="#00ff00" stroke-width="3"/>
                        <rect x="35" y="10" width="30" height="15" rx="3" fill="none" stroke="#00ff00" stroke-width="3"/>
                        <line x1="35" y1="50" x2="65" y2="50" stroke="#00ff00" stroke-width="3"/>
                        <line x1="35" y1="70" x2="65" y2="70" stroke="#00ff00" stroke-width="3"/>
                        <line x1="35" y1="90" x2="65" y2="90" stroke="#00ff00" stroke-width="3"/>
                        <text x="50" y="110" text-anchor="middle" fill="#00ff00" font-size="20" font-weight="bold">+</text>
                    `;

                    container.appendChild(battery);

                    setTimeout(() => {
                        if (battery.parentNode) {
                            battery.remove();
                        }
                    }, 12000);
                }, i * 400);
            }
        }

        setInterval(createFallingBatteries, 8000);
        createFallingBatteries();

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aa5f99e514f7cc9',t:'MTc2NTEzMDk3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
